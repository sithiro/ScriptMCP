name: Release ScriptMCP.Console

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute Version And Tag
        id: version
        shell: bash
        run: |
          set -euo pipefail

          # If this commit already has a ScriptMCP-v* tag, reuse it.
          existing_tag="$(git tag --points-at HEAD | grep -E '^ScriptMCP-v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || true)"
          if [[ -n "$existing_tag" ]]; then
            echo "tag=$existing_tag" >> "$GITHUB_OUTPUT"
            echo "version=${existing_tag#ScriptMCP-v}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find latest ScriptMCP-v* tag, default to 1.0.0 if none exists.
          latest_tag="$(git tag --list 'ScriptMCP-v*' --sort=-v:refname | head -n 1 || true)"
          if [[ -z "$latest_tag" ]]; then
            major=1
            minor=0
            patch=0
          else
            version="${latest_tag#ScriptMCP-v}"
            IFS='.' read -r major minor patch <<< "$version"
          fi

          # Increment patch; roll over patch 0-9 into minor.
          patch=$((patch + 1))
          if [[ "$patch" -ge 10 ]]; then
            patch=0
            minor=$((minor + 1))
          fi

          next_version="${major}.${minor}.${patch}"
          next_tag="ScriptMCP-v${next_version}"
          echo "tag=$next_tag" >> "$GITHUB_OUTPUT"
          echo "version=$next_version" >> "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$next_tag"
          git push origin "$next_tag"

  publish:
    runs-on: ubuntu-latest
    needs: version
    strategy:
      fail-fast: false
      matrix:
        rid: [win-x64, linux-x64, osx-x64, osx-arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Publish
        run: |
          dotnet publish ScriptMCP.Console/ScriptMCP.Console.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:PublishTrimmed=false \
            -o artifacts/ScriptMCP.Console-${{ matrix.rid }}

          # Rename the published executable to scriptmcp(.exe)
          if [[ "${{ matrix.rid }}" == win-* ]]; then
            mv "artifacts/ScriptMCP.Console-${{ matrix.rid }}/ScriptMCP.Console.exe" \
               "artifacts/ScriptMCP.Console-${{ matrix.rid }}/scriptmcp.exe"
          else
            mv "artifacts/ScriptMCP.Console-${{ matrix.rid }}/ScriptMCP.Console" \
               "artifacts/ScriptMCP.Console-${{ matrix.rid }}/scriptmcp"
            chmod +x "artifacts/ScriptMCP.Console-${{ matrix.rid }}/scriptmcp"
          fi

      - name: Package
        run: |
          cd artifacts
          zip -r scriptmcp-${{ matrix.rid }}.zip ScriptMCP.Console-${{ matrix.rid }}

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: ScriptMCP ${{ needs.version.outputs.version }}
          files: artifacts/scriptmcp-${{ matrix.rid }}.zip
